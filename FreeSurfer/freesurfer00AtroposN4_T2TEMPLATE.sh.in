#!/bin/bash
#$ -pe smp 10
#$ -q PINC,UI,CCOM
#$ -m e
#$ -M tien-tong@uiowa.edu
#$ -o /Users/tientong/logs/abcd/N4/out
#$ -e /Users/tientong/logs/abcd/N4/err

if [ -f "/Shared/tientong_scratch/abcd/derivatives/atroposn4/SUBJECTID_MRQID_t2.log" ] ; then
   echo "subject log already exists"
  else
   cd /Shared/tientong_scratch/abcd/derivatives/atroposn4
   touch SUBJECTID_MRQID_t2.log
  fi

subject_log=/Shared/tientong_scratch/abcd/derivatives/n4atropos/SUBJECTID_MRQID_t2.log

echo '#--------------------------------------------------------------------------------' >> ${subject_log}
echo 'task: N4 Atropos bias correction' >> ${subject_log}
echo 't2: T2' >> ${subject_log}
echo 'software: ANTS 2.3.1' >> ${subject_log}
echo 'software: AFNI 18.2.04' >> ${subject_log}
date +"start_time: %Y-%m-%d_%H-%M-%S" >> ${subject_log}

if [ -d "/Shared/tientong_scratch/abcd/derivatives/prep/SUBJECTID/MRQID/anat" ] ; then
   echo "directory already exists"   
  else
   mkdir -p /Shared/tientong_scratch/abcd/derivatives/prep/SUBJECTID/MRQID/anat
  fi

outdir=/Shared/tientong_scratch/abcd/derivatives/prep/SUBJECTID/MRQID/anat

export ANTSPATH=/Shared/pinc/sharedopt/apps/ants/Linux/x86_64/2.3.1/bin
export AFNIPATH=/Shared/pinc/sharedopt/apps/afni/Linux/x86_64/18.2.04

3dAutomask -prefix $outdir/SUBJECTID_MRQID_T2w_mask.nii.gz T2 2>&1 | tee ${subject_log}

$ANTSPATH/antsAtroposN4.sh \
	-d 3 \
	-a T2 \
	-x $outdir/SUBJECTID_MRQID_T1w_mask.nii.gz \
	-c 3 -o $outdir/SUBJECTID_MRQID_T1w_ 2>&1 | tee ${subject_log}

date +"end_time: %Y-%m-%d_%H-%M-%S" >> ${subject_log}
echo '' >> ${subject_log}
